<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="C&#43;&#43;のWeb Framework oat&#43;&#43; で Hello World">
<meta itemprop="description" content="大きめのデータ（といっても100万点のオーダだけど）を扱うWebアプリを作りたいのだが Pythonだと遅いので、C&#43;&#43;で書きたい。 ということ">
<meta itemprop="datePublished" content="2019-05-11T22:03:29+09:00" />
<meta itemprop="dateModified" content="2019-05-11T22:03:29+09:00" />
<meta itemprop="wordCount" content="1820">



<meta itemprop="keywords" content="C&#43;&#43;,oat&#43;&#43;,Web," />
<meta property="og:title" content="C&#43;&#43;のWeb Framework oat&#43;&#43; で Hello World" />
<meta property="og:description" content="大きめのデータ（といっても100万点のオーダだけど）を扱うWebアプリを作りたいのだが Pythonだと遅いので、C&#43;&#43;で書きたい。 ということ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.omoikane.dev/posts/oat&#43;&#43;/" />
<meta property="article:published_time" content="2019-05-11T22:03:29+09:00" />
<meta property="article:modified_time" content="2019-05-11T22:03:29+09:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="C&#43;&#43;のWeb Framework oat&#43;&#43; で Hello World"/>
<meta name="twitter:description" content="大きめのデータ（といっても100万点のオーダだけど）を扱うWebアプリを作りたいのだが Pythonだと遅いので、C&#43;&#43;で書きたい。 ということ"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>C&#43;&#43;のWeb Framework oat&#43;&#43; で Hello World</title>
	<link rel="stylesheet" href="https://www.omoikane.dev/css/style.min.6a2d94be52e9f033aff88558e28aa96de11244b0a70e7537f6c33589e8d2d124.css" integrity="sha256-ai2UvlLp8DOv+IVY4oqpbeESRLCnDnU39sM1iejS0SQ=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.omoikane.dev">omoikane.dev</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.omoikane.dev/posts/">Posts</a>
					<a href="https://www.omoikane.dev/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/jm6xxu" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/chomy" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.omoikane.dev/posts/">Posts</a></li>
			<li><a href="https://www.omoikane.dev/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>May 11, 2019</span></div>
				<h1>C&#43;&#43;のWeb Framework oat&#43;&#43; で Hello World</h1>
			</header>
			<div class="content">
				<p>大きめのデータ（といっても100万点のオーダだけど）を扱うWebアプリを作りたいのだが
Pythonだと遅いので、C++で書きたい。
ということで、oat++というC++で書かれたフレームワークがあったので、スケルトンコードを作成してみた。
ドキュメントもあまり詳しくなく、ちょっと苦労したので忘れないようにblogで公開しておく。</p>
<p>前述の通りoat++は、C++で書かれたWebフレームワークでパフォーマンスがべらぼうに良いらしい。
まぁネイティブコードなのでそりゃ速いよねー もちろんオープンソース。
さらに他のライブラリに依存しないのが使いやすそう。</p>
<p>oat++のWebページは、https://oatpp.io GitHubのリポジトリは、 <a href="https://github.com/oatpp/oatpp">https://github.com/oatpp/oatpp</a> である。
今回は、Debian9 stretchでコンパイル、実行を行った。</p>
<h2 id="インストール方法">インストール方法<a href="#インストール方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt-get -y install build-essential cmake git
git clone https://github.com/oatpp/oatpp <span class="o">&amp;&amp;</span> mkdir oatpp/build
<span class="nb">cd</span> oatpp/build <span class="o">&amp;&amp;</span> cmake .. <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> sudo make install
</code></pre></div><p>必要なパッケージは、build-essentialとcmakeがあれば特にいらない。gitでcloneしてbuildするだけ。
かんたんかんたん。</p>
<h2 id="hello-world">Hello World<a href="#hello-world" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>さて、ここからが本題。
今回作成したコードは、以下の3つのファイルである。
<a href="https://github.com/oatpp/example-crud">https://github.com/oatpp/example-crud</a> を参考にした。</p>
<ul>
<li>app.cc</li>
<li>app_component.hh</li>
<li>controller.hh</li>
</ul>
<h3 id="appcc">app.cc<a href="#appcc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//app.cc
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/network/server/Server.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;./app_component.hh&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;./controller.hh&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">AppComponent</span> <span class="n">components</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">router</span> <span class="o">=</span> <span class="n">components</span><span class="p">.</span><span class="n">httpRouter</span><span class="p">.</span><span class="n">getObject</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">::</span><span class="n">createShared</span><span class="p">();</span>
        <span class="n">controller</span><span class="o">-&gt;</span><span class="n">addEndpointsToRouter</span><span class="p">(</span><span class="n">router</span><span class="p">);</span>

        <span class="n">oatpp</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">Server</span> <span class="n">server</span><span class="p">(</span><span class="n">components</span><span class="p">.</span><span class="n">serverConnectionProvider</span><span class="p">.</span><span class="n">getObject</span><span class="p">(),</span> <span class="n">components</span><span class="p">.</span><span class="n">serverConnectionHandler</span><span class="p">.</span><span class="n">getObject</span><span class="p">());</span>
        <span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
        <span class="n">oatpp</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">Environment</span><span class="o">::</span><span class="n">init</span><span class="p">();</span>
        <span class="n">run</span><span class="p">();</span>
        <span class="n">oatpp</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">Environment</span><span class="o">::</span><span class="n">destroy</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div><p>まずは、main関数が含まれるapp.cc。サーバの初期化と起動を行っている。</p>
<h3 id="app_componenthh">app_component.hh<a href="#app_componenthh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>次に、app_component.hhは、app.ccのrun関数で、serverを初期化に必要なオブジェクトインスタンスを作成するクラスAppComponentを
定義している。</p>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">// app_conponent.hh
</span><span class="c1"></span><span class="cp">#pragma onece
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;oatpp/web/server/HttpConnectionHandler.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/web/server/HttpRouter.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/network/server/SimpleTCPConnectionProvider.hpp&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;oatpp/core/macro/component.hpp&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cm">/**
</span><span class="cm"> *  Class which creates and holds Application components and registers components in oatpp::base::Environment
</span><span class="cm"> *  Order of components initialization is from top to bottom
</span><span class="cm"> */</span>
<span class="k">class</span> <span class="nc">AppComponent</span> <span class="p">{</span>
        <span class="k">private</span><span class="o">:</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>

        <span class="k">public</span><span class="o">:</span>
    
  <span class="cm">/**
</span><span class="cm">   *  Create ConnectionProvider component which listens on the port
</span><span class="cm">   */</span>
  <span class="n">OATPP_CREATE_COMPONENT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">oatpp</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">ServerConnectionProvider</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">serverConnectionProvider</span><span class="p">)([]</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">oatpp</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">SimpleTCPConnectionProvider</span><span class="o">::</span><span class="n">createShared</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
  <span class="p">}());</span>
  
  <span class="cm">/**
</span><span class="cm">   *  Create Router component
</span><span class="cm">   */</span>
  <span class="n">OATPP_CREATE_COMPONENT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">HttpRouter</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">httpRouter</span><span class="p">)([]</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">HttpRouter</span><span class="o">::</span><span class="n">createShared</span><span class="p">();</span>
  <span class="p">}());</span>
  
  <span class="cm">/**
</span><span class="cm">   *  Create ConnectionHandler component which uses Router component to route requests
</span><span class="cm">   */</span>
  <span class="n">OATPP_CREATE_COMPONENT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">oatpp</span><span class="o">::</span><span class="n">network</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">HttpRouter</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">serverConnectionHandler</span><span class="p">)([]</span> <span class="p">{</span>
    <span class="n">OATPP_COMPONENT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">HttpRouter</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">router</span><span class="p">);</span> <span class="c1">// get Router component
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">HttpConnectionHandler</span><span class="o">::</span><span class="n">createShared</span><span class="p">(</span><span class="n">router</span><span class="p">);</span>
  <span class="p">}());</span>  
<span class="p">};</span>
</code></pre></div><p>OATPP_CREATE_COMPONENT マクロは、oatpp/core/macro/component.hpp で以下のように定義されている。</p>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#define OATPP_CREATE_COMPONENT(TYPE, NAME) \
</span><span class="cp">oatpp::base::Environment::Component&lt;TYPE&gt; NAME = oatpp::base::Environment::Component&lt;TYPE&gt;
</span></code></pre></div><p>変数を宣言しているだけでした。</p>
<p>このクラスでは、ServerConnectionProvider、HttpRouter、HttpConnectionHandlerを作成している。</p>
<h3 id="controllerhh">controller.hh<a href="#controllerhh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>そして、controller.hhでは、URLマッピングと呼ばれたときの処理を記述する、Controllerクラスを定義している。</p>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//controller.hh
</span><span class="c1"></span><span class="cp">#pragma onece
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;oatpp/web/server/api/ApiController.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/parser/json/mapping/ObjectMapper.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/core/macro/codegen.hpp&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;oatpp/core/macro/component.hpp&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">class</span> <span class="nc">Controller</span> <span class="o">:</span> <span class="k">public</span> <span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">api</span><span class="o">::</span><span class="n">ApiController</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
        <span class="n">Controller</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ObjectMapper</span><span class="o">&gt;&amp;</span> <span class="n">objectMapper</span><span class="p">)</span>
                <span class="o">:</span> <span class="n">oatpp</span><span class="o">::</span><span class="n">web</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="n">api</span><span class="o">::</span><span class="n">ApiController</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">)</span>
        <span class="p">{}</span>

        <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">createShared</span><span class="p">(</span><span class="n">OATPP_COMPONENT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ObjectMapper</span><span class="o">&gt;</span><span class="p">,</span><span class="n">objectMapper</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Controller</span><span class="o">&gt;</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">);</span>
        <span class="p">}</span>


<span class="cp">#include</span> <span class="cpf">OATPP_CODEGEN_BEGIN(ApiController)</span><span class="cp">
</span><span class="cp"></span>
<span class="n">ENDPOINT</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">html</span> <span class="o">=</span>
    <span class="s">&#34;&lt;html lang=&#39;en&#39;&gt;&#34;</span>
    <span class="s">&#34;&lt;head&gt;&#34;</span>
    <span class="s">&#34;&lt;meta charset=utf-8/&gt;&#34;</span>
    <span class="s">&#34;&lt;/head&gt;&#34;</span>
    <span class="s">&#34;&lt;body&gt;&#34;</span>
    <span class="s">&#34;&lt;p&gt;Hello World&lt;/p&gt;&#34;</span>
    <span class="s">&#34;&lt;/body&gt;&#34;</span>
    <span class="s">&#34;&lt;/html&gt;&#34;</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">response</span> <span class="o">=</span> <span class="n">createResponse</span><span class="p">(</span><span class="n">Status</span><span class="o">::</span><span class="n">CODE_200</span><span class="p">,</span> <span class="n">html</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">putHeader</span><span class="p">(</span><span class="n">Header</span><span class="o">::</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="s">&#34;text/html&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ENDPOINT</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/get&#34;</span><span class="p">,</span> <span class="n">get_test</span><span class="p">,</span> <span class="n">REQUEST</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IncomingRequest</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">getQueryParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">response</span> <span class="o">=</span> <span class="n">createResponse</span><span class="p">(</span><span class="n">Status</span><span class="o">::</span><span class="n">CODE_200</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">putHeader</span><span class="p">(</span><span class="n">Header</span><span class="o">::</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">ENDPOINT</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;/post&#34;</span><span class="p">,</span> <span class="n">post_test</span><span class="p">,</span> <span class="n">BODY_STRING</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">response</span> <span class="o">=</span> <span class="n">createResponse</span><span class="p">(</span><span class="n">Status</span><span class="o">::</span><span class="n">CODE_200</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">putHeader</span><span class="p">(</span><span class="n">Header</span><span class="o">::</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">ENDPOINT</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/query-test&#34;</span><span class="p">,</span> <span class="n">query_test</span><span class="p">,</span> 
        <span class="n">QUERY</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s">&#34;lon&#34;</span><span class="p">),</span> <span class="n">QUERY</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="s">&#34;lat&#34;</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">resp</span><span class="p">;</span>
        <span class="n">resp</span><span class="o">&lt;&lt;</span> <span class="s">&#34;p=&#34;</span><span class="o">&lt;&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">()</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34;q=&#34;</span><span class="o">&lt;&lt;</span><span class="n">q</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">response</span> <span class="o">=</span> <span class="n">createResponse</span><span class="p">(</span><span class="n">Status</span><span class="o">::</span><span class="n">CODE_200</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">putHeader</span><span class="p">(</span><span class="n">Header</span><span class="o">::</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">ENDPOINT</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/tile/${z}/${x}/${y}&#34;</span><span class="p">,</span> <span class="n">path_test</span><span class="p">,</span> 
        <span class="n">PATH</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">PATH</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">PATH</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">HEADER</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
<span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">resp</span><span class="p">;</span>
        <span class="n">resp</span><span class="o">&lt;&lt;</span> <span class="s">&#34;zoomlevel = &#34;</span><span class="o">&lt;&lt;</span> <span class="n">z</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34;x = &#34;</span><span class="o">&lt;&lt;</span> <span class="n">x</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34;y = &#34;</span><span class="o">&lt;&lt;</span> <span class="n">y</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34;param = &#34;</span><span class="o">&lt;&lt;</span> <span class="n">param</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">response</span> <span class="o">=</span> <span class="n">createResponse</span><span class="p">(</span><span class="n">Status</span><span class="o">::</span><span class="n">CODE_200</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">putHeader</span><span class="p">(</span><span class="n">Header</span><span class="o">::</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>



<span class="cp">#include</span> <span class="cpf">OATPP_CODEGEN_END(ApiController)</span><span class="cp">
</span><span class="cp"></span><span class="p">};</span>
</code></pre></div><p>各、URLマッピングは、ENDPOINTマクロを使用する。
ENDPOINTマクロは、OATPP_CODEGEN_BEGIN()と、OATPP_CODEGEN_END()で囲む。
<code>#include OATPP_CODEGEN_BEGIN(ApiController)</code>は、<code>#include oatpp/codegen/codegen_define_ApiController_.hpp</code>に展開される。
oatpp/codegen_define_ApiController_.hppでは、ENDPOINTマクロで使用するマクロ類が宣言されている。</p>
<p>ENDPOINTマクロは、見てわかるように、<code>#define ENDPOINT(METHOD, PATH, NAME, ...)</code>と宣言されており、
oatpp::web::protocol::http::outgoing::Response を返す関数に展開される。
4番目以降のパラメータは、パラメータマッピングで、関数での処理に必要なリクエストパラメータを指定する。</p>
<h4 id="parameter-mapping">Parameter Mapping<a href="#parameter-mapping" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>oat++には、以下のパラメータマッピングがある</p>
<ul>
<li>ヘッダ</li>
</ul>
<pre><code>HEADER(&lt;data-type&gt;, &lt;param-name&gt;, &quot;&lt;optional header-name&gt;&quot;)
</code></pre><ul>
<li>パス</li>
</ul>
<pre><code>PATH(&lt;data-type&gt;, &lt;param-name&gt;, &quot;&lt;optional path-variable-name&gt;&quot;)
</code></pre><ul>
<li>クエリ</li>
</ul>
<pre><code>QUERY(&lt;data-type&gt;, &lt;param-name&gt;, &quot;&lt;optional path-variable-name&gt;&quot;)
</code></pre><ul>
<li>Body</li>
</ul>
<pre><code>BODY_STRING(String, &lt;param-name&gt;)
</code></pre><ul>
<li>リクエスト</li>
</ul>
<pre><code>REQUEST(std::shared_ptr&lt;IncomingRequest&gt;, request)
</code></pre><ul>
<li>DTO</li>
</ul>
<pre><code>BODY_DTO(&lt;DTO-class&gt;::ObjectWrapper, &lt;param-name&gt;)
</code></pre><p>パラメータマッピングは、https://oatpp.io/docs/components/api-controller/ にドキュメントがあるが、
正直、どう書くのかほとんどわからなかった。
前掲の<code>controller.hh</code>がサンプルになっていると思う。</p>
<p>data-typeは、以下の型が使えることを確認した。Booleanも使えるかも。</p>
<ul>
<li>String</li>
<li>Int32</li>
<li>Int64</li>
<li>Float32</li>
<li>Float64</li>
</ul>
<h2 id="makefile">Makefile<a href="#makefile" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>一応、Makefileも。</p>
<div class="highlight"><pre class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="nv">CXX</span><span class="o">=</span>g++
<span class="nv">CXXFLAGS</span><span class="o">=</span>-I /usr/local/include/oatpp-0.19.4/oatpp --std<span class="o">=</span>c++11 -w -Wall
<span class="nv">LDFLAGS</span><span class="o">=</span>-L /usr/local/lib/oatpp-0.19.4/ -loatpp -loatpp-test -lpthread

<span class="nf">all</span><span class="o">:</span> <span class="n">app</span>

<span class="nf">.o</span><span class="o">:</span>.<span class="n">cc</span>
        <span class="k">$(</span>CXX<span class="k">)</span> -c <span class="k">$(</span>CXXFLAGS<span class="k">)</span> $&lt;

<span class="nf">app</span><span class="o">:</span> <span class="n">app</span>.<span class="n">o</span> 
        <span class="k">$(</span>CXX<span class="k">)</span>  -o <span class="nv">$@</span> $&lt; <span class="k">$(</span>LDFLAGS<span class="k">)</span>

<span class="nf">app.o</span><span class="o">:</span> <span class="n">app</span>.<span class="n">cc</span> <span class="n">app_component</span>.<span class="n">hh</span>

<span class="nf">clean</span><span class="o">:</span>
        rm -f app *.o
</code></pre></div><p>Have Fan!</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.omoikane.dev/tags/c&#43;&#43;">C&#43;&#43;</a></span><span class="tag"><a href="https://www.omoikane.dev/tags/oat&#43;&#43;">oat&#43;&#43;</a></span><span class="tag"><a href="https://www.omoikane.dev/tags/web">Web</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1820 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-05-11 22:03 &#43;0900</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#インストール方法">インストール方法</a></li>
    <li><a href="#hello-world">Hello World</a>
      <ul>
        <li><a href="#appcc">app.cc</a></li>
        <li><a href="#app_componenthh">app_component.hh</a></li>
        <li><a href="#controllerhh">controller.hh</a></li>
      </ul>
    </li>
    <li><a href="#makefile">Makefile</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.omoikane.dev/posts/install-openbsd-in-encrypted-partition/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>OpenBSD6.5を暗号化パーティションにインストールする方法</span>
			</a>
			<a class="prev-post" href="https://www.omoikane.dev/posts/openbsd-ipv6-sakura/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>OpenBSD6.4をインストールしたVPSでIPv6を使う際の注意</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://www.omoikane.dev">omoikane</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.omoikane.dev/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.omoikane.dev/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
